---
phase: 05-polish-and-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/layout/system_view.py
  - src/layout/scorecard.py
  - assets/custom.css
autonomous: true
requirements: [EXP-01]

must_haves:
  truths:
    - "User can click an Export / Print button and the browser print dialog opens"
    - "Print preview shows the RAG scorecard table and all four comparison charts"
    - "Print preview hides sidebar, navbar, hybrid builder dropdowns, sliders, legend badges, and the export button itself"
  artifacts:
    - path: "src/layout/system_view.py"
      provides: "Export button placement and scorecard card wrapper"
      contains: "export-btn"
    - path: "src/layout/scorecard.py"
      provides: "clientside_callback triggering window.print()"
      contains: "clientside_callback"
    - path: "assets/custom.css"
      provides: "@page fix and @media print rules"
      contains: "@media print"
  key_links:
    - from: "src/layout/scorecard.py"
      to: "export-btn"
      via: "clientside_callback Input/Output"
      pattern: "clientside_callback.*export-btn"
    - from: "assets/custom.css"
      to: "browser print dialog"
      via: "@media print rules hiding non-report elements"
      pattern: "@media print"
---

<objective>
Add scorecard export via browser print-to-PDF and the supporting print CSS.

Purpose: Satisfies EXP-01 — students can export the scorecard summary and charts for lab reports. This is the only unmet v1 requirement that adds new functionality.
Output: Export button in scorecard section, clientside_callback for window.print(), @media print CSS hiding non-report elements.
</objective>

<execution_context>
@C:/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-polish-and-deployment/05-CONTEXT.md
@.planning/phases/05-polish-and-deployment/05-RESEARCH.md
@src/layout/system_view.py
@src/layout/scorecard.py
@assets/custom.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export button, scorecard card wrapper, and print clientside_callback</name>
  <files>src/layout/system_view.py, src/layout/scorecard.py</files>
  <action>
In system_view.py:
1. Import dbc.Button if not already imported
2. Create the export button: `dbc.Button("Export / Print", id="export-btn", color="secondary", outline=True, size="sm", className="mb-2 no-print")`
3. Wrap the existing `scorecard-container` div and `comparison-text` div in a `dbc.Card(dbc.CardBody([...]), className="shadow-sm mb-3")`. Place the export button INSIDE the CardBody, ABOVE scorecard-container — this satisfies "at the top of the scorecard section, near the heading" from CONTEXT.md
4. Do NOT put export-btn inside scorecard-container (that div is replaced by the scorecard callback on every hybrid slot change, which would destroy the button). The button must be a sibling above scorecard-container within the CardBody.

In scorecard.py:
1. Add import: `from dash import clientside_callback` (module-level import, alongside existing `callback` import)
2. Add the clientside_callback at module level (outside any function):
```python
clientside_callback(
    """
    function(n_clicks) {
        if (!n_clicks) return window.dash_clientside.no_update;
        window.print();
        return window.dash_clientside.no_update;
    }
    """,
    Output("export-btn", "n_clicks"),
    Input("export-btn", "n_clicks"),
    prevent_initial_call=True,
)
```
3. Ensure Output and Input are imported from dash (they should already be imported for existing callbacks).

IMPORTANT: Do NOT use `app.clientside_callback` — use the module-level `clientside_callback` function from dash, consistent with the project's existing callback import pattern.
  </action>
  <verify>
Run `python -c "from src.layout import scorecard; from src.layout import system_view; print('imports OK')"` — no import errors. Then run `python app.py` and confirm the app starts; verify the export button is visible in the browser on any system tab (Mechanical, Electrical, or Hybrid). Click the button and confirm the browser print dialog opens.
  </verify>
  <done>Export / Print button visible above scorecard on system tabs. Clicking it opens the browser print dialog. Button has className="no-print" so it will be hidden in print view once CSS is added.</done>
</task>

<task type="auto">
  <name>Task 2: Add @media print CSS and no-print class assignments</name>
  <files>assets/custom.css, src/layout/charts.py, src/layout/hybrid_builder.py</files>
  <action>
In assets/custom.css, append the following CSS rules AFTER the existing sidebar transition block:

1. Add `@page { size: auto; }` as a TOP-LEVEL rule (NOT inside @media print). This fixes the Bootstrap/dbc Chrome print dialog issue (GitHub dbc #269) where the Layout option disappears.

2. Add the @media print block:
```css
@media print {
    /* Navigation and sidebar */
    .navbar,
    #sidebar,
    .sidebar-toggle-btn { display: none !important; }

    /* System tab bar and breadcrumb */
    #system-tabs,
    #back-to-overview { display: none !important; }

    /* Interactive controls and export button */
    .no-print { display: none !important; }

    /* Hybrid builder inputs (results only, not inputs per CONTEXT.md) */
    .hybrid-builder-section { display: none !important; }

    /* Chart control panel (sliders, legend badges) */
    .chart-controls { display: none !important; }

    /* Ensure content fills page width */
    #page-content {
        padding: 0 !important;
        margin-left: 0 !important;
    }

    /* Keep charts visible and full-width */
    .dcc-graph,
    .js-plotly-plot {
        width: 100% !important;
    }

    /* Page break control */
    .scorecard-print-section {
        page-break-inside: avoid;
    }
}
```

In src/layout/charts.py:
- Find the control panel card (the one containing the time-horizon slider and/or legend badges) and add `className="chart-controls"` to its wrapper. If it already has a className, append "chart-controls" to it (e.g., `className="shadow-sm chart-controls"`).

In src/layout/hybrid_builder.py:
- Find the outermost wrapper div returned by `make_hybrid_builder()` and add `className="hybrid-builder-section"` to it. If it already has a className, append "hybrid-builder-section" to it.

Do NOT hide dcc.Graph components with display:none — that causes Plotly layout reflow issues. Only hide non-chart UI (navbar, sidebar, controls, builder inputs).
  </action>
  <verify>
Run `python app.py`, navigate to a system tab (e.g., Mechanical), click "Export / Print". In the print preview: (1) sidebar and navbar are hidden, (2) export button is hidden, (3) scorecard table is visible, (4) all four charts are visible, (5) slider controls are hidden, (6) if on Hybrid tab with all slots filled, the hybrid builder dropdowns are hidden but charts and scorecard show hybrid data.
  </verify>
  <done>Print preview shows only the scorecard and comparison charts. All navigation, controls, and hybrid builder inputs are hidden. Charts render at full width. Chrome print dialog shows the Layout option (portrait/landscape).</done>
</task>

</tasks>

<verification>
1. `python app.py` starts without errors
2. Export button visible on system tabs, hidden on overview (it's only in system_view)
3. Clicking export opens browser print dialog
4. Print preview shows scorecard + 4 charts, hides everything else
5. Chrome print dialog has Layout option (portrait/landscape) — @page fix working
</verification>

<success_criteria>
- EXP-01 satisfied: user can export/print the scorecard summary for lab reports
- Print view includes RAG scorecard + all comparison charts
- Print view excludes hybrid builder inputs, sidebar, navbar, controls
- No new pip dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/05-polish-and-deployment/05-01-SUMMARY.md`
</output>
