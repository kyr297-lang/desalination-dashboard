---
phase: 11-terminology-and-display-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/layout/scorecard.py
  - src/layout/equipment_grid.py
  - src/layout/charts.py
  - src/data/processing.py
autonomous: false
requirements:
  - POLISH-01
  - POLISH-02
  - POLISH-03
  - POLISH-04

must_haves:
  truths:
    - "Scorecard row header reads 'Total Power (kW)' not 'Total Energy (kW)'"
    - "Equipment accordion badge label reads 'Power' not 'Energy'"
    - "Energy breakdown chart y-axis reads 'Power (kW)' and chart card title reads 'Power Breakdown'"
    - "Energy breakdown chart uses grouped bar mode (barmode='group') not stacked"
    - "Numeric values in equipment grid badges and detail table display at 2 significant figures"
    - "Numeric values in scorecard (cost, land, power) display at 2 significant figures"
  artifacts:
    - path: "src/layout/scorecard.py"
      provides: "Scorecard with 'Total Power (kW)' row header and 2-sig-fig formatting"
      contains: "Total Power"
    - path: "src/layout/equipment_grid.py"
      provides: "Equipment badges with 'Power' label and 2-sig-fig display"
      contains: "Power"
    - path: "src/layout/charts.py"
      provides: "Grouped bar chart with 'Power (kW)' y-axis label"
      contains: "Power (kW)"
    - path: "src/data/processing.py"
      provides: "fmt_sig2 helper for 2 significant figure formatting"
      contains: "fmt_sig2"
  key_links:
    - from: "src/layout/scorecard.py"
      to: "src/data/processing.py"
      via: "fmt_sig2 import for 2-sig-fig cost/land/power display"
      pattern: "fmt_sig2"
    - from: "src/layout/equipment_grid.py"
      to: "src/data/processing.py"
      via: "fmt_sig2 import for 2-sig-fig badge and detail values"
      pattern: "fmt_sig2"
---

<objective>
Rename all "Energy" labels to "Power" across the dashboard, switch the power breakdown chart from stacked to grouped bar mode, and format all numeric values to a consistent 2 significant figures.

Purpose: Final polish pass so the dashboard uses correct engineering terminology (power in kW, not energy) and presents numbers at a consistent precision suitable for engineering comparison.
Output: Updated scorecard.py, equipment_grid.py, charts.py, and processing.py with terminology fixes, chart mode change, and 2-sig-fig formatting.
</objective>

<execution_context>
@C:/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key functions and patterns the executor needs. Extracted from codebase. -->

From src/data/processing.py:
```python
def fmt_cost(value) -> str:  # "$X.XM", "$X.XK", "$X,XXX", or "N/A"
def fmt_num(value) -> str:   # "1,234.5" — general numeric with 1 decimal
def fmt(value) -> str:       # "1,234" — comma-formatted integer pass-through
```

From src/layout/scorecard.py (lines 218, 259 — BOTH branches):
```python
html.Th("Total Energy (kW)")  # <-- rename to "Total Power (kW)"
```

From src/layout/equipment_grid.py:
```python
# Line 86 — badge label in _make_summary_badges():
("Energy", _fmt_energy(row.get("energy_kw")))  # <-- rename to "Power"

# Line 124 — detail table row label in _make_detail_table():
("Energy", _fmt_energy(row.get("energy_kw")))  # <-- rename to "Power"

# Lines 228, 240 — cross-system comparison table header and fmt loop:
html.Th("Energy")  # <-- rename to "Power"
("Energy", _fmt_energy, "")  # <-- rename key to "Power"

# Lines 181, 197, 211 — comparison_rows dict key and metric_cols:
"Energy": r.get("energy_kw")  # <-- rename to "Power"
metric_cols = ["Cost", "Energy", "Land Area"]  # <-- rename to "Power"
```

From src/layout/charts.py:
```python
# Line 331 — energy bar chart y-axis:
yaxis_title="Energy (kW)"  # <-- rename to "Power (kW)"

# Line 329 — bar mode:
barmode="stack"  # <-- change to "group"

# Lines 590-591 — chart card title and description:
"Energy Breakdown"  # <-- rename to "Power Breakdown"
"Energy use by process stage (kW)"  # <-- rename to "Power use by process stage (kW)"
```

From src/data/processing.py — existing formatting approach:
```python
# pd.to_numeric(value, errors="coerce") for safe conversion
# pd.isna(n) check for non-numeric values
# float(n) cast before formatting
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename "Energy" labels to "Power" across scorecard, equipment grid, and charts</name>
  <files>src/layout/scorecard.py, src/layout/equipment_grid.py, src/layout/charts.py</files>
  <action>
  Make exact string replacements in three files. No logic changes — label-only renames.

  **src/layout/scorecard.py:**
  - Line 218: `html.Th("Total Energy (kW)")` -> `html.Th("Total Power (kW)")`
  - Line 259: `html.Th("Total Energy (kW)")` -> `html.Th("Total Power (kW)")`
  - Both are inside `make_scorecard_table()`, one in the `has_hybrid` branch and one in the `else` branch. Use replace_all since both instances are identical strings.

  **src/layout/equipment_grid.py:**
  - Function `_fmt_energy` (line 44): rename to `_fmt_power`. Update the docstring to say "Format power value with kW unit, or 'N/A'."
  - Line 86 in `_make_summary_badges()`: change `("Energy", _fmt_energy(...)` to `("Power", _fmt_power(...)`
  - Line 124 in `_make_detail_table()`: change `("Energy", _fmt_energy(...)` to `("Power", _fmt_power(...)`
  - Lines 181, 197: change `"Energy": r.get("energy_kw")` to `"Power": r.get("energy_kw")`
  - Line 211: change `metric_cols = ["Cost", "Energy", "Land Area"]` to `metric_cols = ["Cost", "Power", "Land Area"]`
  - Line 228: change `html.Th("Energy")` to `html.Th("Power")`
  - Line 240: change `("Energy", _fmt_energy, "")` to `("Power", _fmt_power, "")`

  **src/layout/charts.py:**
  - Line 331: change `yaxis_title="Energy (kW)"` to `yaxis_title="Power (kW)"`
  - Line 590: change `"Energy Breakdown"` to `"Power Breakdown"`
  - Line 591: change `"Energy use by process stage (kW)"` to `"Power use by process stage (kW)"`

  Do NOT rename the internal Python variable names like `energy_kw`, `mech_energy`, `elec_energy`, `energy_breakdown` — those are internal data keys, not user-facing labels. Only rename what users see in the rendered dashboard.
  </action>
  <verify>
    <automated>cd "C:/Users/kevin/Downloads/Desalination Project Vibe Code" && python -c "from src.layout.scorecard import make_scorecard_table; from src.layout.equipment_grid import make_equipment_section; from src.layout.charts import build_energy_bar_chart; print('All imports OK')" && python -m pytest tests/ -x -q 2>&1 | tail -5</automated>
  </verify>
  <done>
  - Scorecard row header reads "Total Power (kW)" in both 2-system and 3-system branches
  - Equipment badge reads "Power" not "Energy" in collapsed summary
  - Equipment detail table row reads "Power" not "Energy"
  - Cross-system comparison table header and data keys use "Power" not "Energy"
  - Chart y-axis reads "Power (kW)" and card title reads "Power Breakdown"
  - All existing tests pass (no internal keys were changed)
  </done>
</task>

<task type="auto">
  <name>Task 2: Change power breakdown chart to grouped bar and add 2-sig-fig formatting</name>
  <files>src/layout/charts.py, src/data/processing.py, src/layout/scorecard.py, src/layout/equipment_grid.py</files>
  <action>
  Two changes: (A) switch bar chart mode, (B) add 2-significant-figure formatting.

  **(A) Grouped bar chart — src/layout/charts.py:**
  In `build_energy_bar_chart()`, change `barmode="stack"` to `barmode="group"` (line 329).
  This is the only change needed — the figure builder already creates one trace per stage with system names as x-labels. Grouped mode will display stage bars side-by-side within each system group.

  **(B) 2-significant-figure formatting — src/data/processing.py:**
  Add a new function `fmt_sig2(value) -> str` that formats any numeric value to 2 significant figures:

  ```python
  def fmt_sig2(value) -> str:
      """Format a numeric value to 2 significant figures.

      Uses Python's built-in round() with negative ndigits for values >= 10
      and string formatting for smaller values. Non-numeric or None -> "N/A".

      Examples:
          1200    -> "1,200"
          1234.5  -> "1,200"
          0.00456 -> "0.0046"
          85      -> "85"
          0.5     -> "0.50"

      Parameters
      ----------
      value : any
          Raw value from a DataFrame cell.

      Returns
      -------
      str
      """
      if value is None:
          return "N/A"
      numeric = pd.to_numeric(value, errors="coerce")
      if pd.isna(numeric):
          return str(value)
      v = float(numeric)
      if v == 0:
          return "0"
      # Python's f-string with .2g gives 2 significant figures
      formatted = f"{v:.2g}"
      # For large integers (e.g. 1200.0 -> "1.2e+03"), convert back to number and use comma format
      result = float(formatted)
      if result == int(result) and abs(result) >= 1:
          return f"{int(result):,}"
      return formatted
  ```

  **Apply fmt_sig2 in scorecard.py:**
  Import `fmt_sig2` from `src.data.processing` (add to existing import line).
  In `make_scorecard_table()`:
  - Replace cost formatting: change `fmt_cost(mech["cost"])` etc. to `fmt_cost(mech["cost"])` — keep fmt_cost for dollar values as it already has its own abbreviated format ($X.XK, $X.XM). Cost already displays well.
  - Replace land area formatting: change `f"{mech['land_area']:.1f} m\u00b2"` to `f"{fmt_sig2(mech['land_area'])} m\u00b2"` (all 4 occurrences in both branches — lines 205-206, 209-210, 250-251, 254-255).
  - Replace energy/power formatting: change `f"{mech['efficiency']:,.0f} kW"` to `f"{fmt_sig2(mech['efficiency'])} kW"` (all 4 occurrences in both branches — lines 221, 225, 262, 266).

  **Apply fmt_sig2 in equipment_grid.py:**
  Import `fmt_sig2` from `src.data.processing` (add to existing import line).
  Update `_fmt_power` (renamed in Task 1) to use fmt_sig2:
  ```python
  def _fmt_power(value) -> str:
      """Format power value with kW unit, or 'N/A'."""
      n = pd.to_numeric(value, errors="coerce")
      if pd.isna(n):
          return "N/A"
      return f"{fmt_sig2(float(n))} kW"
  ```
  Update `_fmt_land` to use fmt_sig2:
  ```python
  def _fmt_land(value) -> str:
      """Format land area value with m2 unit, or 'N/A'."""
      n = pd.to_numeric(value, errors="coerce")
      if pd.isna(n):
          return "N/A"
      return f"{fmt_sig2(float(n))} m\u00b2"
  ```
  Update `_fmt_lifespan` — leave as-is (lifespan uses integer years or "indefinite", 2 sig figs not applicable).
  Update quantity display in `_make_summary_badges()`: change `fmt(row.get("quantity"))` to `fmt_sig2(row.get("quantity"))`.
  Update quantity display in `_make_detail_table()`: change `fmt(row.get("quantity"))` to `fmt_sig2(row.get("quantity"))`.

  Do NOT change `fmt_cost` calls — dollar formatting already has its own clear format.
  </action>
  <verify>
    <automated>cd "C:/Users/kevin/Downloads/Desalination Project Vibe Code" && python -c "
from src.data.processing import fmt_sig2
assert fmt_sig2(1200) == '1,200'
assert fmt_sig2(1234.5) == '1,200'
assert fmt_sig2(0.00456) == '0.0046'
assert fmt_sig2(85) == '85'
assert fmt_sig2(None) == 'N/A'
assert fmt_sig2(0) == '0'
print('fmt_sig2 tests PASS')
" && python -m pytest tests/ -x -q 2>&1 | tail -5</automated>
  </verify>
  <done>
  - build_energy_bar_chart uses barmode="group" producing a grouped (not stacked) bar chart
  - fmt_sig2() function exists in processing.py and correctly rounds to 2 significant figures
  - Scorecard land area and power values use fmt_sig2
  - Equipment grid badge and detail values for power and land use fmt_sig2
  - All existing tests still pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of terminology, chart mode, and formatting</name>
  <files>n/a</files>
  <action>
  Human verifies the rendered dashboard matches all four POLISH requirements.
  </action>
  <what-built>
  Renamed all "Energy" labels to "Power", switched power breakdown chart from stacked to grouped bar, and applied 2-significant-figure formatting across the dashboard.
  </what-built>
  <how-to-verify>
  1. Run the app: `cd "C:/Users/kevin/Downloads/Desalination Project Vibe Code" && python app.py`
  2. Open http://127.0.0.1:8050 in a browser.
  3. Click on "Mechanical" system card:
     a. Verify the scorecard row reads "Total Power (kW)" — NOT "Total Energy (kW)"
     b. Verify scorecard numeric values appear at 2 significant figures (e.g. 1,200 not 1,234.5)
     c. Expand any equipment accordion item and check the badge reads "Power" not "Energy"
     d. Check the expanded detail table row label reads "Power" not "Energy"
     e. Scroll to "Power Breakdown" chart card — verify title says "Power Breakdown"
     f. Verify the y-axis label says "Power (kW)"
     g. Verify the chart shows grouped (side-by-side) bars, NOT stacked bars
  4. Click "Electrical" tab and repeat checks 3a-3g.
  5. Verify no errors in the browser console or terminal.
  </how-to-verify>
  <verify>
    <automated>cd "C:/Users/kevin/Downloads/Desalination Project Vibe Code" && python -m pytest tests/ -x -q</automated>
  </verify>
  <done>Human confirms all four POLISH requirements are visually satisfied in the running app.</done>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `python -m pytest tests/ -x -q` — all existing tests pass (no internal data keys changed)
- `python -c "from src.data.processing import fmt_sig2; ..."` — fmt_sig2 unit checks pass
- Visual: scorecard says "Total Power (kW)", equipment badges say "Power", chart title says "Power Breakdown", chart is grouped bar
- Visual: numeric values in scorecard and equipment grid show 2 significant figures
</verification>

<success_criteria>
1. The string "Total Energy" does not appear anywhere in the rendered dashboard — replaced by "Total Power"
2. The string "Energy" does not appear as a badge label or table header in equipment views — replaced by "Power"
3. The power breakdown chart displays as a grouped bar chart (bars side-by-side per system)
4. Numeric values in the equipment grid and scorecard are formatted to 2 significant figures
5. All existing automated tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/11-terminology-and-display-polish/11-01-SUMMARY.md`
</output>
