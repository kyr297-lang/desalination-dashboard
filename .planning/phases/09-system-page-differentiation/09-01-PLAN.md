---
phase: 09-system-page-differentiation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/layout/system_view.py
  - src/layout/shell.py
  - assets/custom.css
autonomous: false
requirements:
  - DIFF-01
  - DIFF-02

must_haves:
  truths:
    - "Switching to the Mechanical tab produces a visible steel-blue tint across the main content area"
    - "Switching to the Electrical tab produces a visible terra-cotta tint across the main content area"
    - "A small system badge (text only) appears between the tab bar and scorecard, using the system color"
    - "The sidebar background remains neutral (no tint) when either system tab is active"
    - "The tint and badge are both visible in print/PDF — they do not carry the no-print class"
    - "Switching back to the Overview renders no tint (#page-content returns to plain white/default)"
    - "FLATLY cards remain readable — white card surfaces float on the tinted background"
  artifacts:
    - path: "src/layout/system_view.py"
      provides: "System badge component injected between tab bar and scorecard"
      contains: "system_badge"
    - path: "src/layout/shell.py"
      provides: "render_content callback updated to also output page-content style"
      contains: "page-content.*style"
    - path: "assets/custom.css"
      provides: "Print-safe tint rules"
      contains: "print-color-adjust"
  key_links:
    - from: "src/layout/shell.py render_content()"
      to: "page-content style Output"
      via: "Output('page-content', 'style')"
      pattern: "Output.*page-content.*style"
    - from: "src/layout/system_view.py create_system_view_layout()"
      to: "system badge component"
      via: "top_level_children insertion after tab_bar"
      pattern: "system_badge"
    - from: "assets/custom.css"
      to: "tint background-color preserved in print"
      via: "print-color-adjust: exact on #page-content"
      pattern: "-webkit-print-color-adjust"
---

<objective>
Give the Mechanical and Electrical system pages a distinct, page-wide visual identity through a light background tint on `#page-content` and a small system badge below the tab bar.

Purpose: Students can immediately tell which system they are viewing from visual styling alone, without reading the header or tab text.
Output: Two modified Python files (system_view.py, shell.py) and one updated CSS file (custom.css).
</objective>

<execution_context>
@C:/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-system-page-differentiation/09-CONTEXT.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/config.py:
```python
SYSTEM_COLORS = {
    "Mechanical": "#5B8DB8",   # muted steel blue
    "Electrical": "#D4854A",   # muted terra cotta / burnt orange
    "Hybrid":     "#6BAA75",   # muted sage green
}
```

From src/layout/system_view.py — create_system_view_layout signature and assembly:
```python
def create_system_view_layout(active_system: str, data: dict) -> html.Div:
    """
    active_system: "mechanical" | "electrical" | "hybrid"
    """
    # top_level_children is assembled as:
    top_level_children = [
        breadcrumb,   # html.A with class "no-print"
        tab_bar,      # dbc.Tabs
        # badge goes HERE (after tab_bar, before main_content div)
    ]
    # then appended:
    #   html.Div(main_content_children, className="mt-3")
    #   chart_wrapper
    return html.Div(top_level_children)
```

From src/layout/shell.py — render_content callback (current, before changes):
```python
@callback(
    Output("page-content", "children"),
    Input("active-system", "data"),
)
def render_content(active_system):
    from src.layout.overview import create_overview_layout
    from src.layout.system_view import create_system_view_layout
    if active_system is None:
        return create_overview_layout()
    return create_system_view_layout(active_system, _data)
```

From src/layout/shell.py — #page-content div in create_layout():
```python
html.Div(
    id="page-content",
    style={"flex": "1", "padding": "1.5rem"},
    children=[],
),
```

From assets/custom.css — existing @media print block (relevant excerpt):
```css
@media print {
    .no-print { display: none !important; }

    #page-content {
        padding: 0 !important;
        margin-left: 0 !important;
        /* NOTE: background-color is NOT overridden here, so the tint survives */
    }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: System badge in create_system_view_layout()</name>
  <files>src/layout/system_view.py</files>
  <action>
In `create_system_view_layout()` in `src/layout/system_view.py`, build a system badge component and insert it into `top_level_children` immediately after `tab_bar` (before the main content div append).

Implementation:
1. Resolve the display label: `label = active_system.capitalize()` (gives "Mechanical", "Electrical", "Hybrid").
2. Look up the system color: `color = SYSTEM_COLORS.get(label, "#6c757d")`.
3. Build the badge:
   ```python
   system_badge = html.Div(
       dbc.Badge(
           label,
           pill=True,
           style={"backgroundColor": color, "fontSize": "0.85rem"},
       ),
       className="mt-2 mb-1",
       # NOTE: do NOT add no-print class — badge must appear in PDF export
   )
   ```
4. Insert into top_level_children after tab_bar:
   ```python
   top_level_children = [breadcrumb, tab_bar]
   top_level_children.append(system_badge)
   # then append hybrid_builder_section if needed, then main_content div, then chart_wrapper
   ```

Apply the badge for all three systems (Mechanical, Electrical, Hybrid). Hybrid uses `#6BAA75`.

Do NOT modify the breadcrumb, tab bar, scorecard card, equipment card, or chart wrapper logic.
  </action>
  <verify>
    <automated>cd "C:/Users/kevin/Downloads/Desalination Project Vibe Code" && python -c "from src.layout.system_view import create_system_view_layout; print('import OK')"</automated>
  </verify>
  <done>Import succeeds without error. The badge component is inserted after tab_bar in top_level_children. Badge has no no-print class.</done>
</task>

<task type="auto">
  <name>Task 2: Page-wide tint via render_content callback + print CSS</name>
  <files>src/layout/shell.py, assets/custom.css</files>
  <action>
**Part A — shell.py: extend render_content to also output #page-content style.**

Step 1: Add a module-level hex-to-rgba helper above the callbacks section:
```python
def _hex_to_rgba(hex_color: str, alpha: float) -> str:
    """Convert a CSS hex color string to an rgba() string."""
    hex_color = hex_color.lstrip("#")
    r = int(hex_color[0:2], 16)
    g = int(hex_color[2:4], 16)
    b = int(hex_color[4:6], 16)
    return f"rgba({r}, {g}, {b}, {alpha})"

_BASE_CONTENT_STYLE = {"flex": "1", "padding": "1.5rem"}
```

Step 2: Update the render_content callback decorator to include a second Output:
```python
@callback(
    Output("page-content", "children"),
    Output("page-content", "style"),
    Input("active-system", "data"),
)
```

Step 3: Rewrite render_content body to return a 2-tuple:
```python
def render_content(active_system):
    from src.layout.overview import create_overview_layout
    from src.layout.system_view import create_system_view_layout

    if active_system is None:
        no_tint = {**_BASE_CONTENT_STYLE, "backgroundColor": "transparent"}
        return create_overview_layout(), no_tint

    label = active_system.capitalize()
    hex_color = SYSTEM_COLORS.get(label, "#6c757d")
    tint_style = {**_BASE_CONTENT_STYLE, "backgroundColor": _hex_to_rgba(hex_color, 0.18)}
    return create_system_view_layout(active_system, _data), tint_style
```

NOTE: `SYSTEM_COLORS` is already imported in shell.py (`from src.config import SYSTEM_COLORS`). No new imports needed.

**Part B — assets/custom.css: ensure tint survives browser print.**

Add this new rule block after the existing `#sidebar` block and before the `@page` rule:

```css
/* System identity tint — print preservation
   ─────────────────────────────────────────
   The render_content callback applies an inline backgroundColor to
   #page-content when a system tab is active. By default browsers strip
   background-colors when printing. These rules force the tint to print.
   Do NOT add display:none here — the tint is an intentional print identifier. */
#page-content {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
}
```

The existing @media print block for #page-content only overrides padding and margin-left. It does NOT override background-color, so the tint will pass through. No edits needed to the print block itself.
  </action>
  <verify>
    <automated>cd "C:/Users/kevin/Downloads/Desalination Project Vibe Code" && python -c "from src.layout.shell import create_layout; print('shell import OK')"</automated>
  </verify>
  <done>
Import succeeds. Running the app manually confirms:
- Clicking Mechanical: steel-blue tint fills #page-content, sidebar stays neutral
- Clicking Electrical: terra-cotta tint fills #page-content
- Returning to Overview: no tint (transparent)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verify — visual identity and print</name>
  <files>src/layout/system_view.py, src/layout/shell.py, assets/custom.css</files>
  <action>Human verifies the visual result of Tasks 1 and 2: page tint, system badge, and print behavior.</action>
  <what-built>
    Page-wide background tint on #page-content (18% opacity of system color) and a small system name badge below the tab bar. CSS print-color-adjust ensures both features survive PDF export.
  </what-built>
  <how-to-verify>
    1. Start the app: `python app.py` from the project root
    2. Open the browser at http://127.0.0.1:8050 (or configured port)
    3. Click "Mechanical" system card — verify a soft steel-blue background fills the content area
    4. Verify a small "Mechanical" badge (pill-shaped) appears between the tab bar and the scorecard
    5. Click the "Electrical" tab — verify the background immediately shifts to soft terra-cotta/orange
    6. Verify the badge now reads "Electrical" in the terra-cotta color
    7. Click the "Overview" back link — verify the plain white background returns (no tint)
    8. Confirm the sidebar background remains neutral (not tinted) throughout all steps
    9. Open browser print preview (Ctrl+P or Cmd+P) while on the Mechanical tab — confirm the tint and badge are visible in the preview, not stripped to white
  </how-to-verify>
  <verify>
    <automated>MISSING — visual verification only; automated checks in Tasks 1 and 2 cover import correctness</automated>
  </verify>
  <done>User types "approved" after confirming tint, badge, and print behavior are all correct.</done>
  <resume-signal>Type "approved" when verified, or describe any visual issues</resume-signal>
</task>

</tasks>

<verification>
- `python -c "from src.layout.system_view import create_system_view_layout; print('OK')"` passes
- `python -c "from src.layout.shell import create_layout; print('OK')"` passes
- App launches without error
- Mechanical tab: blue tint + "Mechanical" badge visible
- Electrical tab: orange tint + "Electrical" badge visible
- Overview: no tint, no badge
- Sidebar: always neutral
- Print preview: tint and badge visible (not stripped)
</verification>

<success_criteria>
1. The Mechanical system page has a steel-blue (#5B8DB8) background tint at ~18% opacity on #page-content plus a "Mechanical" badge between the tab bar and scorecard (DIFF-01)
2. The Electrical system page has a terra-cotta (#D4854A) background tint at ~18% opacity on #page-content plus an "Electrical" badge between the tab bar and scorecard (DIFF-02)
3. Both tint and badge appear in PDF/print export (no no-print class on either; print-color-adjust: exact in CSS)
4. FLATLY cards remain readable — white dbc.Card surfaces visually float on the tinted background
5. Overview page has no tint
6. Sidebar is always neutral
</success_criteria>

<output>
After completion, create `.planning/phases/09-system-page-differentiation/09-01-SUMMARY.md`
</output>
