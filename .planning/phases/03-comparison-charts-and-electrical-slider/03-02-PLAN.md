---
phase: 03-comparison-charts-and-electrical-slider
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src/layout/charts.py
  - src/layout/system_view.py
autonomous: false
requirements:
  - CHART-01
  - CHART-02
  - CHART-03
  - CHART-04
  - CHART-05
  - CTRL-01
  - CTRL-02
  - VIS-03

must_haves:
  truths:
    - "Cost over time line chart shows all three systems plotted side-by-side with hover tooltips"
    - "Moving the time horizon slider updates the cost chart X-axis range in real time"
    - "Land area grouped bar chart displays all three systems side-by-side"
    - "Wind turbine count grouped bar chart displays all three systems side-by-side"
    - "Energy pie chart shows three pies side by side with per-system energy breakdown"
    - "Moving the battery/tank slider updates the electrical system values across all charts in real time"
    - "Live ratio label shows current battery/tank percentage split"
    - "Live electrical cost readout updates next to the battery slider"
    - "Clicking a system badge in the shared legend toggles that system's visibility across all four charts"
    - "All charts have labeled axes with units and hover tooltips with formatted values"
  artifacts:
    - path: "src/layout/charts.py"
      provides: "Master chart callback, legend toggle callback"
      contains: "def update_charts"
    - path: "src/layout/system_view.py"
      provides: "Chart section integrated below scorecard"
      contains: "make_chart_section"
  key_links:
    - from: "src/layout/charts.py"
      to: "src/data/processing.py"
      via: "callback calls compute_chart_data"
      pattern: "compute_chart_data\\("
    - from: "src/layout/system_view.py"
      to: "src/layout/charts.py"
      via: "import make_chart_section"
      pattern: "from src\\.layout\\.charts import"
    - from: "src/layout/charts.py callback"
      to: "slider-battery and slider-time-horizon"
      via: "Input() in callback decorator"
      pattern: "Input\\(\"slider-"
---

<objective>
Wire the chart section into the system view and create the Dash callbacks that connect sliders, legend toggles, and live labels to the chart figures.

Purpose: This is where the charts become interactive. Plan 01 built the static figure functions and layout; this plan makes everything respond to user interaction with real data flowing through callbacks.

Output: Working interactive chart section below the scorecard with two sliders, shared legend, and four responsive charts.
</objective>

<execution_context>
@C:/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-comparison-charts-and-electrical-slider/03-CONTEXT.md
@.planning/phases/03-comparison-charts-and-electrical-slider/03-RESEARCH.md
@.planning/phases/03-comparison-charts-and-electrical-slider/03-01-SUMMARY.md
@src/layout/charts.py
@src/layout/system_view.py
@src/layout/shell.py
@src/data/processing.py
@src/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add callbacks to charts.py and integrate chart section into system_view.py</name>
  <files>src/layout/charts.py, src/layout/system_view.py</files>
  <action>
**Part A: Add callbacks to charts.py**

Add the following to the BOTTOM of `src/layout/charts.py` (after the existing layout functions from Plan 01).

Add these imports at the top (alongside existing imports):
```python
from dash import callback, Input, Output, State, ctx
from src.data.processing import compute_chart_data, interpolate_battery_cost, battery_ratio_label, fmt_cost
```

**1. Master chart update callback:**
```python
@callback(
    Output("chart-cost", "figure"),
    Output("chart-land", "figure"),
    Output("chart-turbine", "figure"),
    Output("chart-pie", "figure"),
    Output("label-years", "children"),
    Output("label-battery-ratio", "children"),
    Output("label-elec-cost", "children"),
    Input("slider-time-horizon", "value"),
    Input("slider-battery", "value"),
    Input("store-legend-visibility", "data"),
)
def update_charts(years, battery_fraction, visibility):
```
- This callback fires whenever either slider moves or legend visibility changes.
- Accesses data via the `_data` module variable (following existing set_data pattern from shell.py). Add a module-level `_data = None` and `set_data(data)` function in charts.py, mirroring the pattern in shell.py.
- Calls `compute_chart_data(_data, battery_fraction, years)` to get all chart data.
- Calls `build_cost_chart(years, cd["cost_over_time"]["mechanical"], cd["cost_over_time"]["electrical"], cd["cost_over_time"]["hybrid"], visibility)`.
- Calls `build_land_chart(cd["land_area"]["mechanical"], cd["land_area"]["electrical"], cd["land_area"]["hybrid"], visibility)`.
- Calls `build_turbine_chart(cd["turbine_count"]["mechanical"], cd["turbine_count"]["electrical"], cd["turbine_count"]["hybrid"], visibility)`.
- Calls `build_pie_chart(cd["energy_breakdown"]["mechanical"], cd["energy_breakdown"]["electrical"], cd["energy_breakdown"]["hybrid"], visibility)`.
- Live labels:
  - `label_years = f"{years} year{'s' if years != 1 else ''}"`.
  - `label_ratio = battery_ratio_label(battery_fraction)`.
  - `label_cost = f"Electrical total: {fmt_cost(cd['electrical_total_cost'])}"`.
- Returns all 7 outputs: 4 figures + 3 label strings.

**2. Legend toggle callback:**
```python
@callback(
    Output("store-legend-visibility", "data"),
    Input("legend-btn-mechanical", "n_clicks"),
    Input("legend-btn-electrical", "n_clicks"),
    Input("legend-btn-hybrid", "n_clicks"),
    State("store-legend-visibility", "data"),
    prevent_initial_call=True,
)
def toggle_legend(n_mech, n_elec, n_hybrid, visibility):
```
- Uses `ctx.triggered_id` to determine which badge was clicked.
- Maps triggered_id to system key: `{"legend-btn-mechanical": "mechanical", "legend-btn-electrical": "electrical", "legend-btn-hybrid": "hybrid"}`.
- Toggles: `visibility[key] = not visibility[key]`.
- Returns updated visibility dict.

**3. Legend badge styling callback** (visual feedback for toggled-off systems):
```python
@callback(
    Output("legend-btn-mechanical", "style"),
    Output("legend-btn-electrical", "style"),
    Output("legend-btn-hybrid", "style"),
    Input("store-legend-visibility", "data"),
)
def update_badge_styles(visibility):
```
- For each system, if visible: `{"cursor": "pointer", "backgroundColor": SYSTEM_COLORS[label], "fontSize": "0.9rem", "opacity": "1"}`.
- If hidden: same but `"opacity": "0.4"` and add a strikethrough or dimmed look.
- Returns 3 style dicts.

**Part B: Integrate chart section into system_view.py**

Modify `src/layout/system_view.py`:

1. Add import at top: `from src.layout.charts import make_chart_section`
2. In `create_system_view_layout()`, add the chart section BELOW the existing content. Change the return block from:
```python
return html.Div([
    breadcrumb,
    tab_bar,
    html.Div([scorecard, html.Hr(className="my-3"), equipment], className="mt-3"),
])
```
to:
```python
return html.Div([
    breadcrumb,
    tab_bar,
    html.Div([scorecard, html.Hr(className="my-3"), equipment], className="mt-3"),
    make_chart_section(),
])
```

**Part C: Wire data into charts.py**

In `app.py`, after the existing `set_data(DATA)` call for shell.py, add:
```python
from src.layout.charts import set_data as set_chart_data
set_chart_data(DATA)
```
This ensures the chart callbacks have access to the data dict.

Wait — actually, to keep app.py modifications minimal and follow the pattern established: in `system_view.py`, the data is already passed to `create_system_view_layout(active_system, _data)` from shell.py's render_content callback. But charts.py callbacks need data at module level. So add to `app.py` after line 68 (`set_data(DATA)`):
```python
from src.layout.charts import set_data as set_charts_data
set_charts_data(DATA)
```
Add `app.py` to files_modified if not already there. Actually, this is a one-line addition — it's small enough to include here.

IMPORTANT: The file `app.py` needs this one-line addition. Add it right after the existing `set_data(DATA)` call on line 68.
  </action>
  <verify>
Run `python app.py` — the app should start without errors.

In a browser at http://127.0.0.1:8050:
1. Click any system card (e.g., Mechanical) — should see scorecard + equipment + chart section below
2. All four charts should render with real data
3. Move the time horizon slider — cost chart should update in real time
4. Move the battery/tank slider — electrical line should shift, ratio label should update, electrical cost readout should update
5. Click a legend badge — that system should disappear from all four charts
6. Click the badge again — system reappears

Run `python -c "
from src.layout.charts import update_charts, toggle_legend
print('Callbacks registered OK')
"` — should print OK.
  </verify>
  <done>
Master chart callback fires on both slider inputs and legend store, returning four figures and three labels. Legend toggle callback updates visibility store on badge clicks. Badge styling reflects toggled state. Chart section appears below scorecard in system view. All charts respond to slider interaction in real time.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify interactive chart section</name>
  <files>src/layout/charts.py, src/layout/system_view.py</files>
  <action>
Human verification of the complete chart section. No code changes — visual and functional check only.

What was built: Complete chart section with four comparison charts, two sliders, shared legend, and real-time updates.
  </action>
  <verify>
1. Run `python app.py` and open http://127.0.0.1:8050
2. Click any system card (Mechanical or Electrical) to enter system view
3. Scroll down past the scorecard and equipment grid — you should see:
   - "System Comparison" heading
   - Control panel with Time Horizon slider (default: 50 years) and Battery/Tank slider (default: 50% Battery / 50% Tank)
   - Shared legend row with colored badges for Mechanical, Electrical, Hybrid
   - 2x2 grid of charts: Cost Over Time (top-left), Land Area (top-right), Wind Turbines (bottom-left), Energy Breakdown (bottom-right)
4. **Time horizon slider:** Drag to 25 years — cost chart X-axis should shorten to 25. Drag to 1 — should show year 0-1 only. Live label should update.
5. **Battery/tank slider:** Drag left (more tank) — electrical cost should decrease. Drag right (more battery) — electrical cost should increase. Ratio label should show "70% Battery / 30% Tank" etc. Electrical total cost readout should update.
6. **Legend toggle:** Click the "Mechanical" badge — Mechanical should disappear from all four charts. Click again — reappears. Badge should dim when toggled off.
7. **Chart tooltips:** Hover over cost lines — should show "Mechanical: $XX,XXX at Year X". Hover over bar charts — should show values. Hover over pie slices — should show percentage.
8. **Hybrid placeholder:** Hybrid should show 0 in bar charts and "No data" in the energy pie.
9. **Responsive:** Narrow the browser window — charts should reflow to single column.
10. **Animation:** Slider drags should produce smooth transitions, not blinking/flashing charts.
  </verify>
  <done>Human approves that all four charts render correctly with real data, both sliders update charts in real time, legend toggles work across all charts, tooltips show formatted values, and the layout is responsive.</done>
</task>

</tasks>

<verification>
1. App starts with `python app.py` without errors
2. Chart section renders below scorecard in system view
3. All four charts show real data from data.xlsx
4. Both sliders update charts in real time with smooth animation
5. Shared legend toggles system visibility across all four charts
6. Live labels update: year count, battery ratio, electrical total cost
7. All charts have labeled axes and hover tooltips
8. Hybrid shows placeholder data (zeros/no data)
9. Layout is responsive (2-col on desktop, 1-col on narrow)
</verification>

<success_criteria>
- Master callback connects both sliders and legend store to all four chart outputs + 3 labels
- Legend toggle callback updates store on badge clicks
- Badge styling reflects visibility state
- Chart section is integrated into system_view.py below scorecard
- charts.py set_data is called from app.py
- All charts use uirevision="static" to prevent blink on update
- Battery slider correctly overrides Battery (1 day of power) cost via compute_chart_data
- Human verifies the full interactive experience
</success_criteria>

<output>
After completion, create `.planning/phases/03-comparison-charts-and-electrical-slider/03-02-SUMMARY.md`
</output>
