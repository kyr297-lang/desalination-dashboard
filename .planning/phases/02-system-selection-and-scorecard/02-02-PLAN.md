---
phase: 02-system-selection-and-scorecard
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/layout/shell.py
  - src/layout/overview.py
  - src/layout/system_view.py
  - src/layout/scorecard.py
  - src/layout/equipment_grid.py
autonomous: false
requirements:
  - SEL-01
  - SEL-02
  - SEL-03
  - SCORE-01
  - SCORE-02
  - VIS-01
  - VIS-02

must_haves:
  truths:
    - "On first load, user sees a landing page with three system cards (Mechanical, Electrical, Hybrid) and an intro message"
    - "Clicking a system card navigates to the tab view showing that system's scorecard and equipment list"
    - "Tab bar shows Mechanical, Electrical, Hybrid tabs with the active tab highlighted in the system's color"
    - "Scorecard table displays cost, land area, and efficiency with RAG dots (green/red) for each system"
    - "Equipment cards are grouped by process stage with section headers and show all 5 metrics"
    - "Clicking an equipment card expands it to show full description, all data fields, and cross-system comparison"
    - "Only one equipment card is expanded at a time"
    - "Back to Overview link returns to the landing page"
    - "Hybrid tab shows an empty state message until Phase 4"
  artifacts:
    - path: "src/layout/overview.py"
      provides: "Landing page with three system selection cards"
      exports: ["create_overview_layout"]
    - path: "src/layout/system_view.py"
      provides: "Tab bar + content area assembling scorecard and equipment grid"
      exports: ["create_system_view_layout"]
    - path: "src/layout/scorecard.py"
      provides: "RAG scorecard comparison table"
      exports: ["make_scorecard_table"]
    - path: "src/layout/equipment_grid.py"
      provides: "Equipment card grid with accordion detail and cross-system comparison"
      exports: ["make_equipment_section"]
    - path: "src/layout/shell.py"
      provides: "Updated shell with active-system store and content-rendering callback"
  key_links:
    - from: "src/layout/shell.py"
      to: "src/layout/overview.py"
      via: "render_content callback imports create_overview_layout"
      pattern: "create_overview_layout"
    - from: "src/layout/shell.py"
      to: "src/layout/system_view.py"
      via: "render_content callback imports create_system_view_layout"
      pattern: "create_system_view_layout"
    - from: "src/layout/system_view.py"
      to: "src/layout/scorecard.py"
      via: "imports make_scorecard_table"
      pattern: "make_scorecard_table"
    - from: "src/layout/system_view.py"
      to: "src/layout/equipment_grid.py"
      via: "imports make_equipment_section"
      pattern: "make_equipment_section"
    - from: "src/layout/scorecard.py"
      to: "src/data/processing.py"
      via: "imports compute_scorecard_metrics, rag_color, fmt_cost"
      pattern: "from src\\.data\\.processing import"
    - from: "src/layout/equipment_grid.py"
      to: "src/data/processing.py"
      via: "imports fmt_cost, fmt_num, fmt, get_equipment_stage"
      pattern: "from src\\.data\\.processing import"
    - from: "src/layout/equipment_grid.py"
      to: "src/config.py"
      via: "imports EQUIPMENT_DESCRIPTIONS for detail view"
      pattern: "from src\\.config import.*EQUIPMENT_DESCRIPTIONS"
---

<objective>
Build the complete Phase 2 UI: landing overview with system selection cards, tab-based navigation, RAG scorecard table, and equipment card grid with accordion detail expansion and cross-system comparison.

Purpose: This is the main visual deliverable for Phase 2 — students can explore systems, see equipment details, and compare systems at a glance via the scorecard.
Output: 4 new layout modules (overview.py, system_view.py, scorecard.py, equipment_grid.py) and updated shell.py with navigation state management.
</objective>

<execution_context>
@C:/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-system-selection-and-scorecard/02-CONTEXT.md
@.planning/phases/02-system-selection-and-scorecard/02-RESEARCH.md
@.planning/phases/02-system-selection-and-scorecard/02-01-SUMMARY.md
@src/config.py
@src/data/loader.py
@src/data/processing.py
@src/layout/shell.py
@app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create landing overview and update shell with navigation state management</name>
  <files>src/layout/overview.py, src/layout/shell.py</files>
  <action>
**A. Create src/layout/overview.py:**

Export `create_overview_layout()` that returns:
- A brief intro line: html.P with text like "Select a desalination system to explore its equipment and performance" styled as text-muted
- A dbc.Row with three dbc.Col(width=4) — one per system (Mechanical, Electrical, Hybrid)
- Each card (per user decision): dbc.Card with dbc.CardHeader showing system name, styled with backgroundColor = SYSTEM_COLORS[label] and white text; dbc.CardBody with a 1-2 sentence text description (no icons/images) and a dbc.Button("Explore", id={"type": "system-card-btn", "index": system_key})
- Card class: h-100 shadow-sm

System descriptions (Claude's discretion):
- Mechanical: "Uses wind-driven mechanical pumps to directly pressurize seawater through reverse osmosis membranes. Requires multiple large turbines but avoids electrical conversion losses."
- Electrical: "Converts wind energy to electricity to power pumps, with battery or tank storage options for continuous operation. More flexible but adds conversion and storage costs."
- Hybrid: "Combine components from both systems to create a custom desalination solution tailored to specific site conditions."

Import SYSTEM_COLORS from src.config.

**B. Modify src/layout/shell.py:**

1. Add a `dcc.Store(id="active-system", data=None)` to the layout (alongside the existing sidebar-collapsed store).

2. Add a "System Explorer" NavLink to the sidebar nav: `dbc.NavLink("System Explorer", href="#", id="nav-system-explorer")`. Keep existing "Overview" link.

3. Register TWO new callbacks (keep existing sidebar toggle callback):

   **Callback 1: update_active_system** — Updates the active-system store.
   - Inputs: pattern-matching `Input({"type": "system-card-btn", "index": ALL}, "n_clicks")`, `Input("system-tabs", "active_tab")`, `Input("back-to-overview", "n_clicks")`
   - State: `State("active-system", "data")`
   - prevent_initial_call=True
   - Logic: Use `ctx.triggered_id` to determine source. If triggered by system-card-btn → return triggered["index"]. If triggered by system-tabs → return active_tab. If triggered by back-to-overview → return None. Otherwise return current.
   - Import `ctx, ALL` from dash.

   **Callback 2: render_content** — Renders the page content area.
   - Input: `Input("active-system", "data")`
   - Logic: If active_system is None → return `create_overview_layout()`. Otherwise → return `create_system_view_layout(active_system, DATA)`.
   - Import create_overview_layout from overview.py and create_system_view_layout from system_view.py.
   - For the DATA reference: import DATA from app module is circular. Instead, accept data as a module-level variable. Add `_data = None` at module level and a `set_data(data)` function. Call `set_data(DATA)` from app.py after loading data. The render_content callback uses `_data`.

   IMPORTANT (from research — avoid circular callback): Do NOT use `Output("system-tabs", "active_tab")`. The tab bar is RE-RENDERED with the correct active_tab as a static prop each time render_content runs. This avoids the circular dependency.

4. Remove the placeholder text from the page-content children — it will now be populated by the render_content callback.

**C. Update app.py:**

After `app.layout = create_layout(DATA)`, add: `from src.layout.shell import set_data; set_data(DATA)` so the shell module has access to the data for its render callback.

CRITICAL: Per user decisions, the sidebar stays SEPARATE from system selection. Tabs are the system selector, not the sidebar. The sidebar just has navigation links.
  </action>
  <verify>
Run: `python -c "from src.layout.overview import create_overview_layout; layout = create_overview_layout(); print('Overview layout created:', type(layout).__name__)"`
Run: `python app.py &` (start in background), wait 2 seconds, then `curl -s http://127.0.0.1:8050 | head -20` — confirm HTML contains "system-card-btn" and "active-system". Kill the background process.
  </verify>
  <done>Landing overview renders three system cards with colored headers. Shell has active-system store, update callback, and render callback. Clicking a card sets the store and triggers content swap. "Back to Overview" resets to landing.</done>
</task>

<task type="auto">
  <name>Task 2: Create scorecard table, equipment grid with accordion detail, and system view assembly</name>
  <files>src/layout/scorecard.py, src/layout/equipment_grid.py, src/layout/system_view.py</files>
  <action>
**A. Create src/layout/scorecard.py:**

Export `make_scorecard_table(mechanical_df, electrical_df)` returning html.Div containing:
- html.H5("System Scorecard")
- html.P explaining RAG meaning: "Green = best of the compared systems, Red = worst. Lower cost, less land, and less energy are better." (text-muted small)
- A dbc.Table (bordered, hover, responsive) built with html.Thead and html.Tbody
- Header row: "Metric" | "Mechanical" | "Electrical" (Hybrid column omitted per user decision — hidden until Phase 4)
- Three data rows:
  1. "Total Cost" — use fmt_cost() for display, rag_color with metric="cost"
  2. "Total Land Area" — display as "{value:.1f} m²", rag_color with metric="land_area"
  3. "Total Energy (kW)" — display as "{value:,.0f} kW", rag_color with metric="efficiency" (lower = better, label footnoted)
- Each value cell: [make_rag_dot(color), formatted_value] with textAlign center
- An overall ranking summary row at the bottom: count which system has more "green" dots → "Best Overall: {system name}" row spanning full width. If tied, say "Tied".

**make_rag_dot(color_key)** helper — inline in this module or imported from processing. Creates html.Span with 12px circle (borderRadius 50%), backgroundColor from RAG_COLORS[color_key], marginRight 6px, verticalAlign middle.

Import from src.data.processing: compute_scorecard_metrics, rag_color, fmt_cost
Import from src.config: RAG_COLORS

**B. Create src/layout/equipment_grid.py:**

Export `make_equipment_section(df, system, all_data)` where df is the system DataFrame, system is "mechanical"/"electrical"/"hybrid", and all_data is the full data dict (for cross-system comparison).

For Hybrid system (before Phase 4), return an empty state:
- html.Div with html.H5("Hybrid System") and html.P("Build your hybrid system to see equipment here. The hybrid builder will be available in a future update.", className="text-muted fst-italic")

For Mechanical/Electrical:
1. Group equipment by process stage using get_equipment_stage() from processing.py
2. For each stage (in order: Water Extraction, Pre-Treatment, Desalination, Post-Treatment, Brine Disposal, Other):
   - html.H5 section header with the stage name
   - dbc.Accordion (always_open=False, active_item=None) containing one dbc.AccordionItem per equipment item in that stage
3. Each AccordionItem:
   - title: equipment name (bold) + " — " + fmt_cost(cost) (muted, small)
   - item_id: f"item-{system}-{idx}" (unique across all stages)
   - Content (expanded view):
     a. Description text from EQUIPMENT_DESCRIPTIONS (italic, muted). Fall back to "No description available."
     b. Summary badges row: 5 metrics in a dbc.Row of small dbc.Col badges — Qty, Cost, Energy, Land, Lifespan — formatted with units inline ("450 kW", "$42.5K", "2.3 m²", etc.)
     c. Full data table: dbc.Table (bordered, sm) with one row per field (Name, Quantity, Cost, Energy, Land Area, Lifespan) — Th label + Td value, "N/A" for missing
     d. Cross-system comparison: `make_cross_system_comparison(equipment_name, system, all_data)` — a small dbc.Table comparing this equipment's metrics vs. equivalents from other systems for the same process stage. "Equivalents" = equipment items in the same process stage from other systems. Highlight (bold or green text) the best value per metric column. If no equivalent exists in another system, show "N/A".

Import from src.data.processing: fmt_cost, fmt_num, fmt, get_equipment_stage
Import from src.config: EQUIPMENT_DESCRIPTIONS, PROCESS_STAGES
Import pandas as pd for pd.to_numeric in comparison highlighting

**Card styling per user decision:** Cards use shadow-sm class, grid layout with dbc.Row/dbc.Col. However, since the user decided on accordion-style expand (not card click-to-expand), use dbc.Accordion directly — each AccordionItem acts as the "card." The collapsed state shows the equipment name + cost badge (the summary card view), the expanded state shows full detail.

**C. Create src/layout/system_view.py:**

Export `create_system_view_layout(active_system, data)` returning html.Div containing:
1. "Back to Overview" breadcrumb: html.A("← Overview", id="back-to-overview", href="#", className="text-muted small mb-2", style={"cursor": "pointer", "textDecoration": "none"}) — NOT a fourth tab
2. Tab bar: dbc.Tabs with 3 dbc.Tab components (Mechanical, Electrical, Hybrid). Each tab:
   - tab_id = system key ("mechanical", "electrical", "hybrid")
   - label = display name
   - label_style = {"color": "#6c757d"} (muted gray)
   - active_label_style = {"color": SYSTEM_COLORS[label], "fontWeight": "bold", "borderBottom": f"3px solid {SYSTEM_COLORS[label]}"} (per research — use borderBottom, NOT backgroundColor due to known bug)
   - Set active_tab=active_system on the dbc.Tabs component (this is a static prop since the tabs are re-rendered each time)
   - id="system-tabs"
3. Below the tabs: vertical stack layout (per user decision — scorecard on top, equipment list below):
   - make_scorecard_table(data["mechanical"], data["electrical"]) from scorecard.py
   - html.Hr()
   - make_equipment_section(data[active_system], active_system, data) from equipment_grid.py (if active_system is "hybrid" and hybrid not yet built, make_equipment_section handles the empty state)

Import from src.config: SYSTEM_COLORS
Import from src.layout.scorecard: make_scorecard_table
Import from src.layout.equipment_grid: make_equipment_section
  </action>
  <verify>
Run: `python -c "
from src.data.loader import load_data
from src.layout.system_view import create_system_view_layout
d = load_data()
layout = create_system_view_layout('mechanical', d)
print('System view created:', type(layout).__name__)
"`
Confirm: No import errors, layout object created successfully.

Run: `python -c "
from src.data.loader import load_data
from src.layout.scorecard import make_scorecard_table
d = load_data()
table = make_scorecard_table(d['mechanical'], d['electrical'])
print('Scorecard created:', type(table).__name__)
"`
Confirm: Scorecard renders without errors.

Run: `python -c "
from src.data.loader import load_data
from src.layout.equipment_grid import make_equipment_section
d = load_data()
section = make_equipment_section(d['mechanical'], 'mechanical', d)
print('Equipment section created:', type(section).__name__)
"`
Confirm: Equipment section renders with accordion items.
  </verify>
  <done>System view displays tab bar with colored active indicator, scorecard with RAG dots showing correct green/red rankings, and equipment grid grouped by process stage with accordion expansion showing full detail and cross-system comparison.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 2 UI flow</name>
  <files>none</files>
  <action>Human verification checkpoint — no code changes. User tests the full Phase 2 UI flow in the browser.</action>
  <what-built>Landing overview with system selection cards, tab-based navigation, RAG scorecard, and equipment grid with accordion detail expansion and cross-system comparison.</what-built>
  <how-to-verify>
1. Run `python app.py` — app opens in browser at http://127.0.0.1:8050
2. **Landing page:** Confirm you see three system cards (Mechanical, Electrical, Hybrid) with colored headers and an intro message
3. **Card click:** Click the "Explore" button on the Mechanical card — confirm it switches to the tab view with Mechanical active
4. **Tab bar:** Confirm three tabs visible (Mechanical, Electrical, Hybrid). Active tab should have a colored bottom border in the system's color
5. **Scorecard:** Confirm a table appears at top with "Total Cost", "Total Land Area", "Total Energy (kW)" rows, Mechanical and Electrical columns, colored dots (green/red), and formatted values
6. **Equipment list:** Below the scorecard, confirm equipment items grouped by process stage headers (Water Extraction, Pre-Treatment, etc.)
7. **Accordion expand:** Click an equipment item — confirm it expands showing description, data table, and cross-system comparison table. Click another item — confirm the first collapses
8. **Tab switch:** Click the Electrical tab — confirm equipment list changes to electrical system items
9. **Hybrid tab:** Click Hybrid tab — confirm empty state message appears
10. **Back to Overview:** Click "← Overview" link — confirm return to landing page
11. **Sidebar:** Confirm sidebar is still separate and functional (hamburger toggle still works)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
  <verify>User performs the 11-step verification checklist above and reports results.</verify>
  <done>User has confirmed all 11 verification steps pass, or issues have been identified for resolution.</done>
</task>

</tasks>

<verification>
1. App starts without errors: `python app.py`
2. Landing overview shows 3 system cards with correct colors
3. System selection navigates to tab view
4. Scorecard displays RAG-colored metrics for Mechanical and Electrical
5. Equipment items render in process-stage groups with accordion expand
6. Cross-system comparison appears in expanded equipment detail
7. Hybrid tab shows empty state placeholder
8. "Back to Overview" returns to landing
9. No console errors in browser developer tools
</verification>

<success_criteria>
- User can click a system card to enter that system's tab view
- Tab bar highlights the active system with its assigned color
- Scorecard shows cost, land area, and energy with green/red RAG indicators
- Equipment cards grouped by process stage with all 5 metrics visible
- Expanding a card shows description, full data, and cross-system comparison
- Only one card expanded at a time
- Hybrid tab shows placeholder message
- "Back to Overview" returns to landing page
- Academic styling maintained (FLATLY theme, muted colors, shadow-sm cards)
</success_criteria>

<output>
After completion, create `.planning/phases/02-system-selection-and-scorecard/02-02-SUMMARY.md`
</output>
