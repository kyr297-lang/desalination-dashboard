---
phase: 04-hybrid-builder
plan: 02
subsystem: hybrid-builder
tags: [hybrid, gate-overlay, scorecard, charts, dcc.Store, callbacks, equipment-grid]
dependency_graph:
  requires:
    - phase: 04-01
      provides: hybrid_builder layout, compute_hybrid_df, generate_comparison_text, SLOT_STAGES, store-hybrid-slots
  provides:
    - gate overlay blocking charts until all 5 slots filled
    - hybrid data flowing into all 4 comparison charts
    - dynamic 3-column scorecard with hybrid RAG indicators
    - factual comparison text below scorecard when gate is open
    - hybrid equipment detail view (accordion) driven by slot store
    - store-hybrid-slots relocated to app shell for global DOM presence
  affects:
    - src/layout/system_view.py
    - src/layout/charts.py
    - src/layout/scorecard.py
    - src/layout/equipment_grid.py
    - src/layout/hybrid_builder.py
    - src/layout/shell.py
    - app.py
tech_stack:
  added: []
  patterns:
    - "store-hybrid-slots in shell.py ensures the store is always in DOM — all callbacks using it as Input work on every tab"
    - "set_data() pattern extended to scorecard.py — consistent module-level data access"
    - "update_scorecard callback returns both scorecard-container and comparison-text in one call — minimises round trips"
    - "equipment section is callback-driven on hybrid tab (hybrid-equipment-container) and static on other tabs"
key_files:
  created: []
  modified:
    - src/layout/system_view.py
    - src/layout/charts.py
    - src/layout/scorecard.py
    - src/layout/equipment_grid.py
    - src/layout/hybrid_builder.py
    - src/layout/shell.py
    - app.py
key_decisions:
  - "store-hybrid-slots moved to shell.py so it is always in the DOM — chart and scorecard callbacks need it as Input on all tabs, not just the hybrid tab"
  - "update_gate_overlay returns a COMPLETE style dict in both open/closed states — never partial, per anti-pattern guidance"
  - "hybrid equipment section is callback-driven (hybrid-equipment-container) rather than static — static render at layout time would use gate-closed state permanently"
  - "dcc.Dropdown persistence=True / persistence_type='session' on all 5 hybrid dropdowns — selections survive tab switches without writing extra callbacks"
  - "scorecard update_scorecard callback returns both outputs (scorecard-container + comparison-text) in one callback to avoid state fragmentation"

requirements-completed: [HYB-03, HYB-04, SCORE-03]

duration: 21min
completed: 2026-02-22
---

# Phase 4 Plan 2: Hybrid Builder Integration Summary

**Gate-overlay + store-driven hybrid data wired into all 4 charts, dynamic 3-column RAG scorecard with comparison text, and callback-driven equipment accordion for the Hybrid tab.**

## Performance

- **Duration:** 21 min
- **Started:** 2026-02-22T21:19:13Z
- **Completed:** 2026-02-22T21:40:00Z
- **Tasks:** 2 (1 auto + 1 human-verify)
- **Files modified:** 7

## Accomplishments

- Gate overlay (`hybrid-gate-overlay`) blocks the chart section on the Hybrid tab until all 5 slots are filled; disappears instantly on gate open, re-engages on any slot clear
- All 4 comparison charts (cost-over-time, land area, turbine count, energy pie) receive real hybrid data via `compute_hybrid_df` when gate is open; fall back to placeholder zeros when gate is closed
- Scorecard expands from 2-column to 3-column (Mechanical / Electrical / Hybrid) with RAG traffic-light dots across all three systems when gate is open
- Factual percentage-comparison sentences generated by `generate_comparison_text` appear below the scorecard when gate is open
- Hybrid equipment accordion (5 items, one per selected stage) rendered via `update_hybrid_equipment` callback; shows gate message when slots incomplete
- `store-hybrid-slots` relocated to `shell.py` so it is always in the DOM, preventing chart/scorecard callback failures on non-hybrid tabs
- Dropdown `persistence=True` added so slot selections survive switching between Mechanical/Electrical/Hybrid tabs

## Task Commits

1. **Task 1: Integrate hybrid builder into system_view, charts, scorecard, and equipment grid** - `2c5fa91` (feat)
2. **Post-verify bug fix: persist dropdown state + hybrid equipment callback** - `56e31ed` (fix)

**Plan metadata:** *(docs commit — this SUMMARY)*

## Files Created/Modified

- `src/layout/system_view.py` — imports `make_hybrid_builder`; renders pipeline above chart section on hybrid tab; wraps charts in gate overlay container; adds `scorecard-container`, `comparison-text`, `hybrid-equipment-container` divs
- `src/layout/charts.py` — adds `Input("store-hybrid-slots", "data")` to `update_charts`; builds `hybrid_df` when gate open; passes it to `compute_chart_data`
- `src/layout/scorecard.py` — adds `set_data()` pattern; extends `make_scorecard_table` to accept `hybrid_df` for 3-column display; adds `update_scorecard` callback (scorecard + comparison text); adds `update_gate_overlay` callback; adds `update_hybrid_equipment` callback
- `src/layout/equipment_grid.py` — handles `system == "hybrid"` with gate-open accordion vs gate-closed placeholder message
- `src/layout/hybrid_builder.py` — removes `dcc.Store` (moved to shell); adds `persistence=True` to all 5 dropdowns
- `src/layout/shell.py` — adds `store-hybrid-slots` to app shell layout so it is always in the DOM; imports `SLOT_STAGES` from `hybrid_builder`
- `app.py` — calls `set_scorecard_data(DATA)` and `set_hybrid_builder_data(DATA)` after existing `set_data` calls

## Decisions Made

- **`store-hybrid-slots` in shell:** The original plan placed the `dcc.Store` inside `make_hybrid_builder`, which only renders on the Hybrid tab. Chart and scorecard callbacks use it as `Input` and fire on all tabs — moving it to the shell ensures the store is always present in the DOM, matching the pattern already used for `active-system` and `sidebar-collapsed`.
- **Complete style dict for gate overlay:** `update_gate_overlay` always returns the full CSS style dict (not partial updates). This matches the plan's anti-pattern guidance and avoids partial-style Dash pitfalls.
- **Callback-driven equipment on hybrid tab:** Static equipment render at layout time would always show the gate-closed message since `hybrid_df` is never available at layout time. A callback-driven container (`hybrid-equipment-container`) driven by `store-hybrid-slots` ensures equipment updates when slots are filled.
- **Dropdown persistence:** `persistence=True / persistence_type="session"` on all 5 hybrid dropdowns stores slot selections in the browser session. Selections survive tab switches without requiring any additional Dash callbacks or server-side state.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Moved `store-hybrid-slots` from `hybrid_builder.py` to `shell.py`**
- **Found during:** Task 1 (during integration of `update_charts` callback)
- **Issue:** Plan spec placed `dcc.Store(id="store-hybrid-slots")` inside `make_hybrid_builder`, which renders only on the Hybrid tab. The `update_charts` callback adds this store as an `Input`. In Dash 4 with `suppress_callback_exceptions=True`, if an `Input` component is absent from the DOM the callback does not fire — meaning charts on the Mechanical/Electrical tabs would stop working.
- **Fix:** Removed `dcc.Store` from `make_hybrid_builder` and added it to `shell.py` alongside `active-system` and `sidebar-collapsed`, ensuring it is always in the DOM.
- **Files modified:** `src/layout/shell.py`, `src/layout/hybrid_builder.py`
- **Verification:** Import test confirmed `store-hybrid-slots` present in shell layout string; mechanical tab charts verified to render correctly.
- **Committed in:** `2c5fa91` (Task 1 commit)

### Post-Verification Bug Fixes (applied by orchestrator after human verification)

**2. Dropdown state lost on tab switch (fixed in `56e31ed`)**
- **Found during:** Task 2 verification — Step 10 (switch to Mechanical then back to Hybrid)
- **Issue:** `dcc.Dropdown` components in the hybrid pipeline did not have `persistence=True`. When the user switched away from the Hybrid tab (causing a layout re-render), the `render_content` callback produced fresh dropdown components with `value=None`, losing all slot selections.
- **Fix:** Added `persistence=True, persistence_type="session"` to all 5 dropdowns in `_stage_dropdown()` in `hybrid_builder.py`.
- **Files modified:** `src/layout/hybrid_builder.py`
- **Commit:** `56e31ed`

**3. Hybrid equipment section static at layout time (fixed in `56e31ed`)**
- **Found during:** Task 2 verification — Step 8 (click hybrid equipment item)
- **Issue:** `make_equipment_section` was called statically in `create_system_view_layout` with no `hybrid_selected` key in `all_data`. Regardless of slot state, the equipment section always showed the gate-closed placeholder message.
- **Fix:** Replaced static equipment render for `system == "hybrid"` with a callback-driven `html.Div(id="hybrid-equipment-container")` in `system_view.py`. Added `update_hybrid_equipment` callback in `scorecard.py` that reads `store-hybrid-slots`, calls `compute_hybrid_df`, and renders the appropriate accordion or placeholder.
- **Files modified:** `src/layout/system_view.py`, `src/layout/scorecard.py`
- **Commit:** `56e31ed`

---

**Total deviations:** 3 (1 auto-fixed during execution, 2 found in verification and fixed post-checkpoint)
**Impact on plan:** All fixes necessary for correct behavior. No scope creep — all changes directly serve the stated requirements (HYB-03, HYB-04, SCORE-03).

## Issues Encountered

None beyond the deviations documented above.

## Next Phase Readiness

- Phase 4 (Hybrid Builder) is now feature-complete: builder UI, gate enforcement, chart integration, scorecard, comparison text, and equipment detail view all work end-to-end
- Phase 5 can proceed; no blockers

---
*Phase: 04-hybrid-builder*
*Completed: 2026-02-22*
