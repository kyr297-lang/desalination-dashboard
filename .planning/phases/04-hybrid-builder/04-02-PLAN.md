---
phase: 04-hybrid-builder
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/layout/system_view.py
  - src/layout/charts.py
  - src/layout/scorecard.py
  - src/layout/equipment_grid.py
  - app.py
autonomous: false
requirements: [HYB-03, HYB-04, SCORE-03]

must_haves:
  truths:
    - "With fewer than 5 slots filled, charts show overlay message and scorecard has no hybrid column"
    - "With all 5 slots filled, hybrid data appears in all 4 comparison charts"
    - "With all 5 slots filled, scorecard shows hybrid column with RAG indicators"
    - "Comparison description text appears below scorecard when gate is open"
    - "Clearing a slot after gate was met re-engages the gate overlay"
    - "Clicking hybrid equipment shows detail view"
  artifacts:
    - path: "src/layout/system_view.py"
      provides: "Hybrid tab renders builder + gate overlay + charts"
      contains: "make_hybrid_builder"
    - path: "src/layout/charts.py"
      provides: "update_charts accepts store-hybrid-slots Input"
      contains: "store-hybrid-slots"
    - path: "src/layout/scorecard.py"
      provides: "Dynamic scorecard with hybrid column and comparison text"
      contains: "scorecard-container"
    - path: "src/layout/equipment_grid.py"
      provides: "Hybrid equipment detail view from slot selections"
      contains: "hybrid"
    - path: "app.py"
      provides: "set_hybrid_builder_data wired"
      contains: "set_hybrid_builder_data"
  key_links:
    - from: "src/layout/charts.py"
      to: "store-hybrid-slots"
      via: "Input in update_charts callback"
      pattern: "store-hybrid-slots.*data"
    - from: "src/layout/scorecard.py"
      to: "store-hybrid-slots"
      via: "Input in update_scorecard callback"
      pattern: "store-hybrid-slots.*data"
    - from: "src/layout/system_view.py"
      to: "src/layout/hybrid_builder.py"
      via: "make_hybrid_builder import"
      pattern: "from src.layout.hybrid_builder import"
---

<objective>
Wire the hybrid builder into the existing dashboard: gate overlay on charts, hybrid data flowing into all 4 comparison charts, dynamic scorecard with hybrid column, comparison description text, and hybrid equipment detail view.

Purpose: This completes the hybrid builder feature by connecting the slot selections to every output surface — charts, scorecard, and equipment details — with the completion gate enforcing the "all 5 slots required" rule.
Output: Fully functional hybrid builder integrated into all dashboard views
</objective>

<execution_context>
@C:/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-hybrid-builder/04-CONTEXT.md
@.planning/phases/04-hybrid-builder/04-RESEARCH.md
@.planning/phases/04-hybrid-builder/04-01-SUMMARY.md
@src/layout/system_view.py
@src/layout/charts.py
@src/layout/scorecard.py
@src/layout/equipment_grid.py
@app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate hybrid builder into system_view, charts, scorecard, and equipment grid</name>
  <files>src/layout/system_view.py, src/layout/charts.py, src/layout/scorecard.py, src/layout/equipment_grid.py, app.py</files>
  <action>
**system_view.py changes:**
1. Import make_hybrid_builder from src.layout.hybrid_builder
2. When active_system == "hybrid", render the hybrid builder at the top (above charts/scorecard) by calling make_hybrid_builder(data)
3. Wrap the chart section area with a relative-positioned container that includes the gate overlay:
   - html.Div with style={"position": "relative"} containing:
     - The gate overlay: html.Div(id="hybrid-gate-overlay") positioned absolutely, with white semi-transparent background (rgba(255,255,255,0.85)), z-index 10, centered content showing "Fill all 5 slots to see hybrid results" message and the slot counter reference
     - The existing chart section (make_chart_section()) — always rendered behind the overlay
   - The overlay is only added when viewing the hybrid tab. For mechanical/electrical tabs, chart section renders normally without overlay wrapper.
4. Add a div with id="scorecard-container" wrapping the scorecard output so it can be updated by callback
5. Add a div with id="comparison-text" below the scorecard-container for the comparison description text

**charts.py changes:**
1. Add Input("store-hybrid-slots", "data") to the update_charts callback — this is a 4th Input after the existing 3 (slider-time-horizon, slider-battery, store-legend-visibility)
2. Inside update_charts: import compute_hybrid_df from processing.py, build hybrid_df from slots if gate is open, pass hybrid_df to compute_chart_data()
3. The existing figure builders already handle hybrid traces — they just need real data instead of zeros

**scorecard.py changes:**
1. Add module-level _data and set_data() following the same pattern as charts.py and shell.py
2. Add a callback: Input("store-hybrid-slots", "data") -> Output("scorecard-container", "children")
   - Imports compute_hybrid_df, compute_scorecard_metrics, generate_comparison_text from processing.py
   - If gate is open: builds hybrid_df, passes it to make_scorecard_table(mech_df, elec_df, hybrid_df)
   - If gate is closed: renders make_scorecard_table(mech_df, elec_df) (2-system only)
3. Extend make_scorecard_table to accept optional hybrid_df parameter:
   - When provided: add "Hybrid" column header, add hybrid metric cells in each row, rag_color with 3 values
   - When None: render existing 2-system table (backward compatible)
4. Add a second Output("comparison-text", "children") to the scorecard callback (or a separate callback):
   - When gate open: call generate_comparison_text() and render as html.P with text-muted styling
   - When gate closed: return empty string or None

**equipment_grid.py changes:**
1. Modify make_equipment_section to handle system == "hybrid":
   - When hybrid and gate is open (hybrid_df provided via all_data["hybrid_selected"]): render 5 accordion items using existing _make_accordion_item pattern, one per selected equipment
   - When hybrid and gate is closed: return a muted message "Fill all 5 slots to see equipment details."
   - The detail view for each hybrid equipment item should use the same format as mechanical/electrical items

**Gate overlay callback (in system_view.py or hybrid_builder.py):**
1. Add callback: Input("store-hybrid-slots", "data") -> Output("hybrid-gate-overlay", "style")
   - When all 5 slots filled (gate open): return style with display: "none"
   - When any slot is None (gate closed): return style with display: "flex" and the full absolute positioning
   - Always return the COMPLETE style dict (not partial)

**app.py changes:**
1. Import set_data from hybrid_builder (if it has one) and scorecard
2. Call set_scorecard_data(DATA) after the existing set_data calls
3. Call set_hybrid_builder_data(DATA) if hybrid_builder needs module-level data access

**Anti-patterns to avoid:**
- Do NOT call make_chart_section() again in hybrid_builder.py — it is already called once in system_view.py
- Do NOT create duplicate component IDs — the chart IDs (chart-cost, chart-land, etc.) are shared across all tabs
- Do NOT use dash.no_update for the gate overlay style — always return the full style dict
- The gate overlay div must only exist in the DOM when viewing the hybrid tab — or use suppress_callback_exceptions if the ID might not exist
  </action>
  <verify>
Run `python app.py` — app starts with no errors. Navigate to the Hybrid tab: builder pipeline visible at top with 5 dropdowns. Gate overlay visible over charts. Fill all 5 slots: charts update with hybrid data, scorecard shows 3 columns, comparison text appears below scorecard. Clear one slot: gate re-engages.
  </verify>
  <done>
Hybrid builder fully integrated. Gate overlay blocks charts/scorecard until all 5 slots filled. With gate open: hybrid appears in all 4 charts, scorecard shows 3-column RAG table, comparison text shows percentage differences, hybrid equipment detail view works. Clearing a slot re-engages the gate.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete hybrid builder flow</name>
  <files>n/a</files>
  <action>Human verification of the complete hybrid builder feature. All code was automated in Task 1.</action>
  <verify>
1. Run `python app.py` and open http://127.0.0.1:8050 in browser
2. Click "Hybrid" system card or tab
3. Verify: 5 labeled dropdowns visible in a horizontal pipeline with arrows between them
4. Verify: "0/5 slots filled" counter visible, "Clear All" button visible
5. Verify: Charts area shows overlay message "Fill all 5 slots to see hybrid results" with chart outlines behind it
6. Fill 3 of 5 slots — verify counter shows "3/5 slots filled", charts still gated
7. Fill all 5 slots — verify:
   a. Gate overlay disappears instantly (no animation)
   b. All 4 charts show hybrid data (cost line, land bar, turbine bar, energy pie)
   c. Scorecard shows 3 columns (Mechanical, Electrical, Hybrid) with RAG dots
   d. Below scorecard: comparison description text with percentage comparisons
8. Click a hybrid equipment item — verify detail view opens with equipment data
9. Clear one slot using dropdown X or "Clear All" — verify gate re-engages immediately
10. Switch to Mechanical tab, then back to Hybrid — verify builder state persists (slots still filled/cleared)
  </verify>
  <done>User has approved the complete hybrid builder flow — all 10 verification steps pass.</done>
</task>

</tasks>

<verification>
1. `python app.py` starts without errors
2. Hybrid tab shows builder pipeline with 5 dropdowns
3. Gate overlay blocks results until all 5 slots filled
4. All 4 charts update with real hybrid data when gate opens
5. Scorecard shows 3-column table with hybrid metrics and RAG indicators
6. Comparison text shows factual percentage comparisons
7. Equipment detail view works for hybrid items
8. Gate re-engages when any slot is cleared
</verification>

<success_criteria>
- All 5 requirements (HYB-03, HYB-04, SCORE-03) fully implemented and verifiable
- Gate enforces "all 5 slots required" rule with instant show/hide
- Hybrid data flows correctly through all chart computations
- Comparison text is neutral/factual with percentage comparisons
- No duplicate component ID errors, no circular import issues
</success_criteria>

<output>
After completion, create `.planning/phases/04-hybrid-builder/04-02-SUMMARY.md`
</output>
